<div class="profile-container">
  <div class="profile-header">
    <h1>My Profile</h1>
    <p>Manage your personal information and preferences</p>
  </div>

  <div class="profile-content" *ngIf="!loading">
    <!-- Profile Image Section -->
    <mat-card class="image-card">
      <mat-card-content>
        <div class="image-section">
          <div class="avatar-container">
            <img [src]="getProfileImage()" alt="Profile Picture" class="profile-avatar">
            <div class="avatar-overlay">
              <button mat-icon-button (click)="triggerFileInput()" class="change-photo-btn">
                <mat-icon>camera_alt</mat-icon>
              </button>
            </div>
          </div>
          <input 
            #fileInput 
            type="file" 
            accept="image/*" 
            (change)="onFileSelected($event)" 
            style="display: none">
          <div class="image-actions">
            <button mat-raised-button color="primary" (click)="triggerFileInput()">
              <mat-icon>upload</mat-icon>
              Upload Photo
            </button>
            <button 
              mat-stroked-button 
              color="warn" 
              (click)="deleteImage()"
              *ngIf="profile && profile.profileImage && profile.profileImage !== 'default-avatar.png'">
              <mat-icon>delete</mat-icon>
              Remove Photo
            </button>
          </div>
          <p class="image-hint">Allowed: JPG, PNG, GIF. Max size: 5MB</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- JWT Token Section -->
    <mat-card class="token-card">
      <mat-card-content>
        <div class="token-section">
          <div class="token-header">
            <h2>
              <mat-icon>vpn_key</mat-icon>
              Authentication Token
            </h2>
            <mat-icon 
              class="info-icon" 
              matTooltip="Your JWT authentication token used for API requests">
              info
            </mat-icon>
          </div>
          
          <div class="token-status" [class.expired]="isTokenExpired()">
            <mat-icon>{{ isTokenExpired() ? 'error' : 'check_circle' }}</mat-icon>
            <span>{{ isTokenExpired() ? 'Token Expired' : 'Token Active' }}</span>
          </div>

          <div class="token-display">
            <div class="token-text">
              <code>{{ getMaskedToken() }}</code>
            </div>
            <div class="token-actions">
              <button 
                mat-icon-button 
                (click)="toggleTokenVisibility()"
                [matTooltip]="showToken ? 'Hide token' : 'Show token'">
                <mat-icon>{{ showToken ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <button 
                mat-icon-button 
                (click)="copyToken()"
                [matTooltip]="tokenCopied ? 'Copied!' : 'Copy token'"
                [color]="tokenCopied ? 'accent' : ''">
                <mat-icon>{{ tokenCopied ? 'check' : 'content_copy' }}</mat-icon>
              </button>
            </div>
          </div>

          <div class="token-info">
            <div class="info-item">
              <mat-icon>schedule</mat-icon>
              <div>
                <label>Expires At</label>
                <span>{{ getTokenExpiry() }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>code</mat-icon>
              <div>
                <label>Token Length</label>
                <span>{{ jwtToken.length }} characters</span>
              </div>
            </div>
          </div>

          <mat-hint class="token-hint">
            <mat-icon>warning</mat-icon>
            Keep your token secure. Never share it publicly or commit it to version control.
          </mat-hint>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Profile Form -->
    <mat-card class="form-card">
      <mat-card-content>
        <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
          
          <!-- Personal Information Section -->
          <div class="form-section">
            <h2 class="section-title">
              <mat-icon>person</mat-icon>
              Personal Information
            </h2>
            <div class="form-grid">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Full Name</mat-label>
                <input matInput formControlName="name" placeholder="Enter your full name">
                <mat-icon matPrefix>badge</mat-icon>
                <mat-error *ngIf="profileForm.get('name')?.hasError('required')">
                  Name is required
                </mat-error>
                <mat-error *ngIf="profileForm.get('name')?.hasError('minlength')">
                  Name must be at least 2 characters
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" placeholder="your.email@example.com" readonly>
                <mat-icon matPrefix>email</mat-icon>
                <mat-hint>Email cannot be changed</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Phone Number</mat-label>
                <input matInput formControlName="phone" placeholder="9876543210" maxlength="10">
                <mat-icon matPrefix>phone</mat-icon>
                <mat-error *ngIf="profileForm.get('phone')?.hasError('required')">
                  Phone is required
                </mat-error>
                <mat-error *ngIf="profileForm.get('phone')?.hasError('pattern')">
                  Enter valid 10-digit number
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Gender</mat-label>
                <mat-select formControlName="gender">
                  <mat-option *ngFor="let option of genderOptions" [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix>wc</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Date of Birth</mat-label>
                <input 
                  matInput 
                  [matDatepicker]="picker" 
                  formControlName="dateOfBirth"
                  [max]="maxDate">
                <mat-datepicker-toggle matIconPrefix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-hint *ngIf="calculateAge()">Age: {{ calculateAge() }} years</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Occupation</mat-label>
                <input matInput formControlName="occupation" placeholder="Your profession">
                <mat-icon matPrefix>work</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Bio</mat-label>
                <textarea 
                  matInput 
                  formControlName="bio" 
                  placeholder="Tell us about yourself..."
                  rows="4"
                  maxlength="500"></textarea>
                <mat-icon matPrefix>description</mat-icon>
                <mat-hint align="end">
                  {{ profileForm.get('bio')?.value?.length || 0 }}/500
                </mat-hint>
              </mat-form-field>
            </div>
          </div>

          <!-- Address Section -->
          <div class="form-section" formGroupName="address">
            <h2 class="section-title">
              <mat-icon>location_on</mat-icon>
              Address Information
            </h2>
            
            <!-- Address Input with Autocomplete -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Search Address</mat-label>
              <input 
                #addressInput
                matInput 
                formControlName="fullAddress" 
                placeholder="Start typing your address...">
              <mat-icon matPrefix>search</mat-icon>
              <mat-hint>Type to get address suggestions (like Uber/Rapido)</mat-hint>
            </mat-form-field>

            <!-- Map Toggle Button -->
            <div class="map-toggle">
              <button 
                mat-raised-button 
                type="button"
                (click)="toggleMap()"
                [color]="showMap ? 'accent' : 'primary'">
                <mat-icon>{{ showMap ? 'map' : 'add_location' }}</mat-icon>
                {{ showMap ? 'Hide Map' : 'Select on Map' }}
              </button>
              <p class="map-hint">Click on map to set your exact location</p>
            </div>

            <!-- Google Map -->
            <div id="map" class="map-container" *ngIf="showMap"></div>

            <!-- Address Details Grid -->
            <div class="form-grid address-grid">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Street Address</mat-label>
                <input matInput formControlName="street" placeholder="House/Building/Street">
                <mat-icon matPrefix>home</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>City</mat-label>
                <input matInput formControlName="city" placeholder="City">
                <mat-icon matPrefix>location_city</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>State</mat-label>
                <input matInput formControlName="state" placeholder="State/Province">
                <mat-icon matPrefix>map</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>ZIP Code</mat-label>
                <input matInput formControlName="zipCode" placeholder="Postal Code">
                <mat-icon matPrefix>markunread_mailbox</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Country</mat-label>
                <input matInput formControlName="country" placeholder="Country">
                <mat-icon matPrefix>public</mat-icon>
              </mat-form-field>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button 
              mat-raised-button 
              color="primary" 
              type="submit"
              [disabled]="profileForm.invalid || loading">
              <mat-icon>save</mat-icon>
              Save Changes
            </button>
            <button 
              mat-stroked-button 
              type="button"
              (click)="populateForm()"
              [disabled]="loading">
              <mat-icon>refresh</mat-icon>
              Reset
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Loading profile...</p>
  </div>
</div>
